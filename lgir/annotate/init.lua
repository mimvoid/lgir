local string, table = string, table
local lgi = require("lgi")

local write_enums = require("lgir.annotate.enums")
local write_funcs = require("lgir.annotate.functions")

---@param file file*
---@param typelib table
local function write_header(file, typelib)
  local template = [[
---@meta
---@diagnostic disable: duplicate-doc-field
-- Autogenerated with lgir
-- Name: %s
-- Version: %s]]

  file:write(string.format(template, typelib._name, typelib._version))

  if typelib._dependencies ~= nil then
    local deps = {}
    for name, version in pairs(typelib._dependencies) do
      table.insert(deps, string.format("%s-%s", name, version))
    end

    file:write(string.format("\n-- Dependencies: %s", table.concat(deps, ", ")))
  end
end

return function(gir_docs, filename)
  local typelib = lgi.require(gir_docs.name, gir_docs.version):_resolve(true)

  local file, err = io.open(filename, "w")
  if file == nil then
    return err
  end

  write_header(file, typelib)

  local enum_classes, enum_fields = write_enums(typelib._enum, gir_docs.enums)
  local bit_classes, bit_fields = write_enums(typelib._bitfield, gir_docs.bitfields)

  if enum_classes ~= nil then
    file:write("\n", table.concat(enum_classes, "\n"))
  end
  if bit_classes ~= nil then
    file:write("\n", table.concat(bit_classes, "\n"))
  end

  file:write("\n\n", "---@class ", typelib._name)

  if enum_fields ~= nil then
    file:write("\n", table.concat(enum_fields, "\n"))
  end
  if bit_fields ~= nil then
    file:write("\n", table.concat(bit_fields, "\n"))
  end

  file:write("\n", "local ", typelib._name, " = {}")

  if typelib._function ~= nil and gir_docs.functions ~= nil then
    local funcs = table.concat(write_funcs(typelib._name, typelib._function, gir_docs.functions), "\n")
    file:write("\n\n", funcs)
  end

  file:close()
end
